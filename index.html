<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Hua Qing | Fine Art of Gongbi</title>
  <meta name="description" content="Discover the timeless serenity of Chinese Gongbi painting by Hua Qing. Hand-painted masterpieces on silk." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --paper-bg:#fdfbf7;
      --ink-black:#2c2c2c;
      --seal-red:#a83f39;
      --jade-green:#687e75;
    }
    body{
      background-color:var(--paper-bg);
      color:var(--ink-black);
      font-family:'Playfair Display','KaiTi',serif;
      background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    }
    .font-calligraphy{font-family:'Ma Shan Zheng',cursive;}
    .font-song-art{font-family:'ZCOOL XiaoWei',serif;}
    .font-serif-text{font-family:'Noto Serif SC',serif;}
    .seal{
      display:inline-flex;align-items:center;justify-content:center;
      width:48px;height:48px;background-color:var(--seal-red);color:white;
      border-radius:4px;font-size:18px;border:2px solid #8a2e29;
      box-shadow:2px 2px 4px rgba(0,0,0,0.2);font-family:'Ma Shan Zheng',cursive;
      line-height:1;padding-top:4px;
    }
    .nav-link{position:relative;}
    .nav-link::after{
      content:'';position:absolute;width:0;height:1px;bottom:0;left:50%;
      background-color:var(--seal-red);transition:all .3s ease;transform:translateX(-50%);
    }
    .nav-link:hover::after{width:80%;}
    .loader{
      border:3px solid #f3f3f3;border-radius:50%;border-top:3px solid var(--seal-red);
      width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .drop-zone{border:2px dashed var(--seal-red);background:#fff5f5;transition:all .2s;}
    .drop-zone.dragover{background:#ffe0e0;border-color:red;}
    /* YouTube / Video responsive container */
    .video-frame {
      /* Fixed Height & Ratio approach to avoid black bars */
      height: 75vh;
      aspect-ratio: 9 / 16;
      width: auto; /* Let width match ratio */
      
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto; /* Center horizontally */
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .video-frame iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .video-frame video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .video-container-wrapper {
        display: flex;
        justify-content: center;
        background: transparent; /* Transparent so no extra black bars */
        /* overflow: hidden; Removed to allow shadow */
    }
  </style>
</head>

<body class="antialiased">

  <!-- NAV -->
  <nav class="fixed w-full z-50 bg-[#fdfbf7]/90 backdrop-blur-sm border-b border-stone-200 transition-all duration-300" id="navbar">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-20">
        <div class="flex-shrink-0 flex items-center gap-4">
          <div class="seal" data-i18n="seal">Hua</div>
          <span class="text-xl tracking-widest text-stone-800 font-bold pt-1">HUA QING ART</span>
        </div>

        <div class="hidden md:flex space-x-8 items-center">
          <a href="#home" class="nav-link text-stone-600 hover:text-stone-900 px-1 py-2 text-sm uppercase tracking-widest transition-colors" data-i18n="nav.home">Home</a>
          <a href="#about-gongbi" class="nav-link text-stone-600 hover:text-stone-900 px-1 py-2 text-sm uppercase tracking-widest transition-colors" data-i18n="nav.source">The Craft</a>
          <a href="#artist" class="nav-link text-stone-600 hover:text-stone-900 px-1 py-2 text-sm uppercase tracking-widest transition-colors" data-i18n="nav.artist">Artist</a>
          <a href="#gallery" class="nav-link text-stone-600 hover:text-stone-900 px-1 py-2 text-sm uppercase tracking-widest transition-colors" data-i18n="nav.gallery">Gallery</a>
          <a href="#contact" class="bg-stone-800 text-stone-100 px-6 py-2 text-xs uppercase tracking-widest hover:bg-[#a83f39] transition-colors duration-300 shadow-lg" data-i18n="nav.contact">Collect</a>

          <button id="lang-btn" class="ml-4 text-xs font-bold border border-stone-300 px-3 py-1 rounded hover:border-[#a83f39] hover:text-[#a83f39] transition-colors font-serif">
            <span id="lang-btn-text">中</span>
          </button>

          <!-- Auth display -->
          <div id="user-auth-section" class="ml-2 flex items-center gap-3">
            <button id="signin-btn" class="flex items-center gap-2 text-stone-600 hover:text-[#a83f39]">
              <i data-lucide="user" class="w-5 h-5"></i>
              <span id="user-name-display" class="text-xs uppercase">Sign In</span>
            </button>

            <button id="signout-btn" class="hidden text-xs border border-stone-300 px-3 py-1 rounded hover:border-[#a83f39] hover:text-[#a83f39] transition-colors font-serif">
              Sign out
            </button>

            <button id="admin-btn" class="hidden text-xs border border-[#a83f39] text-[#a83f39] px-3 py-1 rounded hover:bg-[#a83f39] hover:text-white transition-colors font-serif">
              Admin
            </button>
          </div>
        </div>

        <div class="md:hidden flex items-center gap-4">
          <button id="lang-btn-mobile" class="text-xs font-bold border border-stone-300 px-2 py-1 rounded">
            <span id="lang-btn-text-mobile">中</span>
          </button>
          <button id="mobile-menu-btn" class="text-stone-600 hover:text-stone-900 focus:outline-none">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="mobile-menu" class="hidden md:hidden bg-[#fdfbf7] border-b border-stone-200">
      <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 text-center">
        <a href="#home" class="block px-3 py-2 text-stone-600 hover:text-[#a83f39] font-serif text-lg" data-i18n="nav.home">Home</a>
        <a href="#about-gongbi" class="block px-3 py-2 text-stone-600 hover:text-[#a83f39] font-serif text-lg" data-i18n="nav.source">The Craft</a>
        <a href="#artist" class="block px-3 py-2 text-stone-600 hover:text-[#a83f39] font-serif text-lg" data-i18n="nav.artist">Artist</a>
        <a href="#gallery" class="block px-3 py-2 text-stone-600 hover:text-[#a83f39] font-serif text-lg" data-i18n="nav.gallery">Gallery</a>
        <button id="signin-btn-mobile" class="block w-full px-3 py-2 text-stone-600 hover:text-[#a83f39] text-center font-serif text-lg">Sign In</button>
        <button id="signout-btn-mobile" class="hidden w-full px-3 py-2 text-stone-600 hover:text-[#a83f39] text-center font-serif text-lg">Sign out</button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section id="home" class="relative h-screen flex items-center justify-center overflow-hidden">
    <div class="absolute inset-0 z-0">
      <img src="https://images.unsplash.com/photo-1695519895085-c13f63810486?q=80&w=2574&auto=format&fit=crop" alt="Background Texture" class="w-full h-full object-cover opacity-20">
      <div class="absolute inset-0 bg-gradient-to-b from-[#fdfbf7] via-transparent to-[#fdfbf7]"></div>
    </div>

    <div class="relative z-10 text-center flex flex-col items-center p-6 w-full px-4">
      <h2 class="text-[#a83f39] text-sm md:text-base tracking-[0.3em] md:tracking-[0.5em] mb-6 uppercase font-bold" data-i18n="hero.subtitle">
        The Ancient Art of Gongbi
      </h2>

      <h1 class="text-4xl sm:text-5xl md:text-7xl mb-8 text-stone-800 font-serif italic tracking-wide whitespace-nowrap" data-i18n="hero.title">
        Timeless Serenity, Painted in Silk
      </h1>

      <p class="text-lg md:text-2xl text-stone-600 font-light italic mb-12" data-i18n="hero.desc">
        "Where the microscopic world meets infinite mindfulness."
      </p>

      <a href="#gallery" class="group relative inline-flex items-center justify-center px-10 py-4 overflow-hidden font-medium text-stone-600 border border-stone-400 rounded-full transition duration-300 ease-out hover:border-[#a83f39] hover:text-[#a83f39]">
        <span class="absolute inset-0 flex items-center justify-center w-full h-full text-white duration-300 -translate-x-full bg-[#a83f39] group-hover:translate-x-0 ease">
          <i data-lucide="arrow-right" class="w-6 h-6"></i>
        </span>
        <span class="absolute flex items-center justify-center w-full h-full text-stone-600 transition-all duration-300 transform group-hover:translate-x-full ease font-serif text-lg uppercase tracking-widest" data-i18n="hero.button">
          Explore Collection
        </span>
        <span class="relative invisible font-serif text-lg" data-i18n="hero.button">Explore Collection</span>
      </a>
    </div>

    <div class="absolute bottom-10 right-10 opacity-60 hidden md:block">
      <div class="border-2 border-[#a83f39] p-2 inline-block transform rotate-3">
        <div class="bg-[#a83f39] text-white p-3 text-2xl writing-mode-vertical font-calligraphy" data-i18n="hero.seal">Hua Qing</div>
      </div>
    </div>
  </section>

  <!-- ABOUT: GONGBI -->
  <section id="about-gongbi" class="py-24 bg-stone-100/50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">

        <div class="order-2 lg:order-1 relative">
          <div class="absolute -top-4 -left-4 w-full h-full border border-stone-300 z-0 rounded-2xl"></div>

          <div class="relative z-10 w-full video-container-wrapper">
            <div id="about-video-container" class="video-frame">
              <!-- injected by JS: YouTube embed -->
            </div>

            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex items-center justify-center gap-2 z-20">
              <button id="video-edit-btn" class="hidden bg-white/20 hover:bg-[#a83f39] text-white px-3 py-1 rounded-full backdrop-blur-md transition-colors items-center gap-2 text-xs border border-white/30 shadow-lg">
                <i data-lucide="edit" class="w-3 h-3"></i> <span data-i18n="video.change">Change</span>
              </button>
            </div>
          </div>
        </div>

        <div class="order-1 lg:order-2">
          <div class="flex items-center gap-4 mb-6">
            <div class="h-px w-16 bg-[#a83f39]"></div>
            <span class="text-[#a83f39] uppercase tracking-widest text-sm font-bold" data-i18n="gongbi.label">The Origin</span>
          </div>

          <h2 class="text-4xl md:text-5xl font-serif mb-8 text-stone-800 italic" data-i18n="gongbi.title">Gongbi: Precision and Poise</h2>

          <div class="space-y-6 text-stone-600 text-lg leading-loose font-serif-text">
            <p data-i18n="gongbi.p1"></p>
            <p data-i18n="gongbi.p2"></p>
            <p data-i18n="gongbi.p3" class="italic text-stone-500"></p>
          </div>

          <ul class="space-y-4 font-serif text-lg mt-8">
            <li class="flex items-center gap-3">
              <i data-lucide="feather" class="text-[#a83f39] w-5 h-5 flex-shrink-0"></i>
              <span class="text-stone-700" data-i18n="gongbi.list1"></span>
            </li>
            <li class="flex items-center gap-3">
              <i data-lucide="droplets" class="text-[#a83f39] w-5 h-5 flex-shrink-0"></i>
              <span class="text-stone-700" data-i18n="gongbi.list2"></span>
            </li>
            <li class="flex items-center gap-3">
              <i data-lucide="layers" class="text-[#a83f39] w-5 h-5 flex-shrink-0"></i>
              <span class="text-stone-700" data-i18n="gongbi.list3"></span>
            </li>
          </ul>
        </div>

      </div>
    </div>
  </section>

  <!-- ARTIST -->
  <section id="artist" class="py-24">
    <div class="max-w-5xl mx-auto px-4 text-center">

      <div class="mb-12 inline-block relative group">
        <div class="relative w-40 h-40 mx-auto mb-6 rounded-full overflow-hidden border-4 border-white shadow-xl">
          <img id="artist-img" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=2488&auto=format&fit=crop" alt="Artist Portrait" class="w-full h-full object-cover">
          <label id="artist-upload-overlay" class="hidden absolute inset-0 bg-black/50 items-center justify-center text-white text-xs cursor-pointer">
            <span data-i18n="artist.uploadTip">Admin: Click to upload avatar</span>
            <input id="artist-file-input" type="file" accept="image/*" class="hidden">
            <input id="video-file-input" type="file" accept="video/*" class="hidden">
          </label>
        </div>

        <h2 class="text-5xl font-serif text-stone-800 mb-2 italic" data-i18n="artist.name">Hua Qing</h2>
        <p class="text-[#a83f39] font-sans text-xs uppercase tracking-[0.3em]" data-i18n="artist.title">Gongbi Artist</p>
      </div>

      <div class="prose prose-stone mx-auto text-xl leading-loose text-stone-600 max-w-3xl font-serif-text relative group">
        <button id="edit-bio-btn" class="hidden absolute -top-8 right-0 text-xs bg-stone-100 hover:bg-[#a83f39] hover:text-white px-3 py-1 rounded transition-colors items-center gap-2 border border-stone-200">
             <i data-lucide="edit-3" class="w-3 h-3"></i> Edit Bio
        </button>
        <p data-i18n="artist.bio1" class="mb-6"></p>
        <p data-i18n="artist.bio2" class="mb-6"></p>
        <p data-i18n="artist.bio3"></p>
      </div>

      <div class="mt-12 flex justify-center gap-16">
        <div class="text-center">
          <span class="block text-5xl font-serif font-bold text-stone-800">20+</span>
          <span class="text-xs text-stone-500 tracking-widest uppercase mt-2" data-i18n="artist.stat1">Years</span>
        </div>
        <div class="text-center">
          <span class="block text-5xl font-serif font-bold text-stone-800">28</span>
          <span class="text-xs text-stone-500 tracking-widest uppercase mt-2" data-i18n="artist.stat2">Exhibitions</span>
        </div>
        <div class="text-center">
          <span class="block text-5xl font-serif font-bold text-stone-800">100+</span>
          <span class="text-xs text-stone-500 tracking-widest uppercase mt-2" data-i18n="artist.stat3">Collections</span>
        </div>
      </div>
    </div>
  </section>

  <!-- GALLERY -->
  <section id="gallery" class="py-24 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <span class="text-[#a83f39] uppercase tracking-widest text-xs font-bold block mb-3" data-i18n="gallery.label">Curated Collection</span>
        <h2 class="text-5xl font-serif text-stone-800 italic" data-i18n="gallery.title">Ink & Rhythm</h2>
      </div>

      <div class="flex justify-center gap-8 mb-12 text-sm text-stone-500 uppercase tracking-widest font-sans">
        <button class="text-[#a83f39] border-b border-[#a83f39] pb-1 filter-btn" data-filter="all" data-i18n="gallery.filter.all">All</button>
        <button class="hover:text-stone-800 transition-colors filter-btn" data-filter="flower" data-i18n="gallery.filter.flower">Flowers</button>
        <button class="hover:text-stone-800 transition-colors filter-btn" data-filter="animal" data-i18n="gallery.filter.animal">Animals</button>
        <button class="hover:text-stone-800 transition-colors filter-btn" data-filter="bird_flower" data-i18n="gallery.filter.bird_flower">Birds & Flowers</button>
      </div>

      <div id="gallery-grid" class="columns-1 md:columns-2 lg:columns-3 gap-8 space-y-8 min-h-[400px]">
        <div class="col-span-full flex justify-center items-center h-40 w-full">
          <div class="loader"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTACT -->
  <section id="contact" class="bg-stone-900 text-stone-200 py-24 relative overflow-hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-16">
        <div>
          <h2 class="text-4xl font-serif text-white mb-6 italic" data-i18n="contact.title">Acquire & Connect</h2>
          <p class="text-stone-400 mb-8 leading-relaxed font-serif-text text-lg" data-i18n="contact.desc"></p>

          <div class="space-y-6 font-sans">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-full bg-stone-800 flex items-center justify-center text-[#a83f39]">
                <i data-lucide="mail"></i>
              </div>
              <div>
                <h4 class="text-white text-xs uppercase tracking-widest">Email</h4>
                <p class="text-stone-400 text-sm">contact@huaqing-art.com</p>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <a href="https://instagram.com" target="_blank" class="w-12 h-12 rounded-full bg-stone-800 flex items-center justify-center text-white hover:bg-[#a83f39] transition-colors duration-300">
                <i data-lucide="instagram"></i>
              </a>
              <div>
                <h4 class="text-white text-xs uppercase tracking-widest">Instagram</h4>
                <p class="text-stone-400 text-sm">@huaqing_gongbi</p>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-stone-800 p-8 rounded-lg shadow-2xl">
          <form onsubmit="event.preventDefault(); alert('Thank you. We will contact you shortly.');" class="space-y-6 font-sans">
            <div>
              <label class="block text-xs text-stone-400 mb-2 uppercase tracking-widest" data-i18n="form.name">Your Name</label>
              <input type="text" class="w-full bg-stone-700 border border-stone-600 text-white px-4 py-3 focus:outline-none focus:border-[#a83f39] transition-colors">
            </div>
            <div>
              <label class="block text-xs text-stone-400 mb-2 uppercase tracking-widest" data-i18n="form.email">Email Address</label>
              <input type="email" class="w-full bg-stone-700 border border-stone-600 text-white px-4 py-3 focus:outline-none focus:border-[#a83f39] transition-colors">
            </div>
            <div>
              <label class="block text-xs text-stone-400 mb-2 uppercase tracking-widest" data-i18n="form.message">Inquiry / Message</label>
              <textarea rows="4" class="w-full bg-stone-700 border border-stone-600 text-white px-4 py-3 focus:outline-none focus:border-[#a83f39] transition-colors"></textarea>
            </div>
            <button type="submit" class="w-full bg-[#a83f39] text-white py-4 uppercase tracking-widest hover:bg-red-800 transition-colors text-xs font-bold" data-i18n="form.submit">
              Send Inquiry
            </button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <footer class="bg-stone-950 text-stone-600 py-12 text-center text-sm border-t border-stone-900 relative">
    <p class="mb-2 font-serif">&copy; 2024 Hua Qing Art. All rights reserved.</p>
    <p class="font-serif italic text-xs mb-8" data-i18n="footer.tagline">Designed for the beauty of tranquility.</p>
  </footer>

  <!-- AUTH MODAL -->
  <div id="authModal" class="fixed inset-0 z-[80] hidden bg-black/80 flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-lg max-w-sm w-full shadow-2xl relative">
      <button id="auth-close" class="absolute top-4 right-4 text-stone-500 hover:text-black">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>

      <div class="flex justify-center gap-6 mb-6 font-serif border-b border-stone-200 pb-2">
        <button id="tab-login" class="text-xl font-bold text-[#a83f39] border-b-2 border-[#a83f39] pb-1 transition-colors">Login</button>
        <button id="tab-register" class="text-xl text-stone-400 hover:text-stone-600 pb-1 transition-colors">Register</button>
      </div>

      <!-- LOGIN -->
      <div id="form-login" class="space-y-4">
        <input type="email" id="login-email" class="w-full border border-stone-300 p-2 rounded font-serif" placeholder="Email">
        <input type="password" id="login-password" class="w-full border border-stone-300 p-2 rounded font-serif" placeholder="Password">
        <button id="login-submit" class="w-full bg-[#a83f39] text-white py-2 rounded font-serif hover:bg-red-800">Sign In</button>
        <p class="text-xs text-stone-400 font-serif-text">Tip: If you don’t have an account, please register first.</p>
      </div>

      <!-- REGISTER -->
      <div id="form-register" class="space-y-4 hidden">
        <input type="email" id="reg-email" class="w-full border border-stone-300 p-2 rounded font-serif" placeholder="Email">
        <input type="password" id="reg-password" class="w-full border border-stone-300 p-2 rounded font-serif" placeholder="Password (min 6 chars)">
        <input type="text" id="reg-nick" class="w-full border border-stone-300 p-2 rounded font-serif" placeholder="Nickname (display name)">
        <button id="reg-submit" class="w-full bg-stone-800 text-white py-2 rounded font-serif hover:bg-stone-700">Create Account</button>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL MODAL (Manager Dashboard) -->
  <div id="adminModal" class="fixed inset-0 z-[90] hidden bg-black/80 flex items-center justify-center p-4">
    <div class="bg-[#fdfbf7] p-8 rounded-xl max-w-4xl w-full shadow-2xl max-h-[90vh] overflow-y-auto relative border border-stone-200">
      <button id="admin-close" class="absolute top-6 right-6 text-stone-400 hover:text-[#a83f39] transition-colors">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>

      <div class="flex items-center gap-4 mb-8 border-b border-stone-200 pb-4">
        <div class="w-12 h-12 bg-[#a83f39] text-white flex items-center justify-center rounded-lg shadow-md">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
        </div>
        <div>
            <h3 class="text-2xl font-serif text-stone-800 italic">Gallery Manager</h3>
            <p class="text-xs text-stone-500 uppercase tracking-widest">Administrator Dashboard</p>
        </div>
      </div>

      <!-- ADMIN PASSWORD (qinghua666) -->
      <div id="admin-password-box" class="bg-white border border-stone-200 rounded-lg p-6 mb-8 shadow-sm">
        <div class="flex items-center gap-3 mb-4">
            <i data-lucide="lock" class="w-5 h-5 text-stone-400"></i>
            <h4 class="text-stone-700 font-bold font-serif">Security Verification</h4>
        </div>
        <p class="text-sm text-stone-500 font-serif-text mb-4">Please enter your manager key to unlock administrative features.</p>
        <div class="flex gap-3">
          <input id="admin-key" type="password" class="flex-1 bg-stone-50 border border-stone-300 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39] transition-colors" placeholder="Enter key...">
          <button id="admin-verify" class="bg-[#a83f39] text-white px-6 py-2 rounded font-serif hover:bg-red-800 transition-colors shadow-md">Unlock</button>
        </div>
        <p id="admin-status" class="mt-3 text-xs font-bold text-[#a83f39] min-h-[1rem]"></p>
      </div>

      <div id="admin-dashboard-content" class="hidden opacity-0 transition-opacity duration-500">
          
        <!-- ADD ARTWORK -->
        <div class="bg-white border border-stone-200 rounded-lg p-6 mb-8 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h4 class="text-lg font-bold font-serif text-stone-800 flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-[#a83f39]"></i>
                    Add New Collection
                </h4>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column: Info -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-1">Title (Chinese)</label>
                        <input type="text" id="new-title-zh" placeholder="e.g. 荷韵" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39] transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-1">Title (English)</label>
                        <input type="text" id="new-title-en" placeholder="e.g. Lotus Rhythm" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39] transition-colors">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-1">Category</label>
                             <div class="relative">
                                 <select id="new-category" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39] appearance-none cursor-pointer">
                                    <option value="flower">Flowers</option>
                                    <option value="animal">Animals</option>
                                    <option value="bird_flower">Birds & Flowers</option>
                                 </select>
                                 <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-stone-400 pointer-events-none"></i>
                             </div>
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-1">Status</label>
                             <div class="relative">
                                 <select id="new-status" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39] appearance-none cursor-pointer">
                                    <option value="Available">Available</option>
                                    <option value="Sold">Sold</option>
                                    <option value="Reserved">Reserved</option>
                                 </select>
                                 <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-stone-400 pointer-events-none"></i>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Details & Desc -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-1">Description (CN)</label>
                        <textarea id="new-desc-zh" rows="2" placeholder="尺寸 | 材质 等细节" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39] transition-colors"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-1">Description (EN)</label>
                        <textarea id="new-desc-en" rows="2" placeholder="Size | Material details" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39] transition-colors"></textarea>
                    </div>
                </div>
            </div>

            <!-- Upload Area -->
            <div class="mt-6">
                <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-2">Artwork Images</label>
                <div id="drop-area" class="group w-full h-40 flex flex-col items-center justify-center rounded-lg cursor-pointer bg-stone-50 border-2 border-dashed border-stone-300 hover:border-[#a83f39] hover:bg-[#a83f39]/5 transition-all duration-300 relative">
                    <div class="flex flex-col items-center text-stone-400 group-hover:text-[#a83f39] transition-colors">
                         <i data-lucide="upload-cloud" class="w-10 h-10 mb-2"></i>
                         <p class="text-sm font-medium">Click or Drag & Drop Images</p>
                         <p class="text-xs opacity-70 mt-1">Supports JPG, PNG (Max 5MB)</p>
                    </div>
                    <input type="file" id="fileElem" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" multiple>
                </div>

                <div id="upload-previews" class="mt-4 flex gap-3 overflow-x-auto min-h-[80px] p-2 border border-stone-100 rounded-lg bg-stone-50/50">
                    <!-- Previews go here -->
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button id="publish-artwork" class="bg-[#a83f39] text-white px-8 py-3 rounded-lg shadow-lg hover:bg-red-800 hover:shadow-xl transition-all duration-300 flex items-center gap-2 font-serif tracking-wide">
                    <i data-lucide="send" class="w-4 h-4"></i>
                    Publish to Gallery
                </button>
            </div>
        </div>

        <!-- USERS LIST -->
        <div class="bg-white border border-stone-200 rounded-lg p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
            <h4 class="text-lg font-bold font-serif text-stone-800 flex items-center gap-2">
                <i data-lucide="users" class="w-5 h-5 text-stone-600"></i>
                Registered Clients
            </h4>
            <button id="load-users" class="text-xs border border-stone-300 px-4 py-2 rounded-full hover:border-[#a83f39] hover:text-[#a83f39] transition-colors font-serif uppercase tracking-widest">
                Refresh List
            </button>
            </div>
            <div id="user-list-content" class="bg-stone-50 border border-stone-100 rounded-lg p-4 text-xs space-y-3 max-h-60 overflow-y-auto">
                <p class="text-stone-400 italic text-center py-4">Click refresh to load user data.</p>
            </div>
        </div>

      </div> <!-- End dashboard content -->

      <!-- EDIT BIO MODAL -->
      <div id="bioModal" class="fixed inset-0 z-[100] hidden bg-black/80 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl max-w-2xl w-full shadow-2xl relative">
            <button id="bio-close" class="absolute top-4 right-4 text-stone-400 hover:text-stone-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h3 class="text-2xl font-serif text-stone-800 mb-6 italic">Edit Artist Biography</h3>
            
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-2">Paragraph 1 (Intro)</label>
                    <textarea id="edit-bio-p1" rows="3" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39]"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-2">Paragraph 2 (Theme)</label>
                    <textarea id="edit-bio-p2" rows="3" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39]"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase tracking-widest mb-2">Paragraph 3 (Philosophy)</label>
                    <textarea id="edit-bio-p3" rows="3" class="w-full bg-stone-50 border border-stone-200 p-3 rounded text-sm focus:outline-none focus:border-[#a83f39]"></textarea>
                </div>
                
                <div class="bg-yellow-50 p-3 rounded text-xs text-yellow-800 border border-yellow-200 flex gap-2">
                    <i data-lucide="alert-circle" class="w-4 h-4 flex-shrink-0"></i>
                    <span>Updating this will overwrite the default text for the <strong>current language</strong>. (Switch language to edit the other version).</span>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button id="bio-cancel" class="px-4 py-2 text-stone-500 hover:text-stone-800 font-serif text-sm">Cancel</button>
                <button id="bio-save" class="bg-[#a83f39] text-white px-6 py-2 rounded shadow hover:bg-red-800 transition-colors font-serif text-sm">Save Changes</button>
            </div>
        </div>
      </div>

    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div id="imgModal" class="fixed inset-0 z-[60] hidden bg-black/95 flex items-center justify-center p-4 overflow-y-auto">
    <button id="modal-close" class="fixed top-6 right-6 text-white hover:text-[#a83f39] transition-colors z-[70]">
      <i data-lucide="x" class="w-10 h-10"></i>
    </button>

    <div class="max-w-7xl w-full flex flex-col lg:flex-row gap-8 items-start justify-center mt-10 mb-10">
      <div class="lg:w-2/3 w-full bg-stone-900/50 p-4 rounded min-h-[600px] max-h-[90vh] overflow-y-auto">
        <div id="modalImagesContainer" class="flex flex-col gap-6"></div>
      </div>

      <div class="text-white lg:w-1/3 w-full bg-stone-900/80 p-6 rounded-lg backdrop-blur-md h-fit">
        
        <!-- Admin Controls (Manager View) -->
        <div id="img-admin-edit-panel" class="hidden mb-6 bg-stone-800/80 rounded-lg p-4 border border-[#a83f39]/50 shadow-lg">
          <div class="flex items-center justify-between mb-4 border-b border-stone-700 pb-2">
              <h4 class="text-[#a83f39] font-bold font-serif text-sm uppercase tracking-widest flex items-center gap-2">
                  <i data-lucide="settings-2" class="w-4 h-4"></i> Manager Actions
              </h4>
          </div>
          
          <div class="space-y-3">
              <div>
                  <label class="block text-[10px] uppercase text-stone-500 font-bold mb-1 tracking-wider">Update Status</label>
                  <div class="flex gap-2">
                      <div class="relative flex-1">
                        <select id="modal-status-select" class="w-full bg-stone-700 text-white py-2 pl-3 pr-8 rounded text-sm border border-stone-600 focus:outline-none focus:border-[#a83f39] appearance-none cursor-pointer">
                            <option value="Available">Available</option>
                            <option value="Sold">Sold</option>
                            <option value="Reserved">Reserved</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-stone-400 pointer-events-none"></i>
                      </div>
                      <button id="status-update-btn" class="bg-[#a83f39] hover:bg-red-700 text-white px-3 py-2 rounded text-xs font-bold uppercase tracking-wide transition-colors">
                          Save
                      </button>
                  </div>
              </div>
              
              <div class="pt-2 border-t border-stone-700/50">
                  <button id="delete-btn" class="w-full flex items-center justify-center gap-2 text-red-400 hover:text-red-300 hover:bg-red-900/20 py-2 rounded transition-colors text-xs uppercase tracking-widest font-bold">
                      <i data-lucide="trash-2" class="w-4 h-4"></i> Delete Collection
                  </button>
              </div>
          </div>
        </div>

        <h3 id="modalTitle" class="text-4xl mb-2 text-[#a83f39] font-serif italic tracking-wide"></h3>
        <p id="modalDesc" class="text-stone-300 text-lg font-serif italic mb-4"></p>

        <div class="flex items-center justify-between gap-3">
          <div id="modalStatus" class="inline-block px-3 py-1 bg-stone-800 text-sm tracking-widest font-serif mb-4"></div>

          <button id="like-btn" class="mb-4 inline-flex items-center gap-2 border border-stone-600 px-3 py-2 rounded hover:border-[#a83f39] hover:text-[#a83f39] transition-colors">
            <i data-lucide="heart" class="w-4 h-4"></i>
            <span id="like-count" class="text-sm">0</span>
          </button>
        </div>

        <div class="mt-6 border-t border-stone-700 pt-6">
          <h4 class="text-lg font-bold mb-4 font-serif">Comments</h4>
          <div id="comments-list" class="space-y-4 max-h-[300px] overflow-y-auto mb-4 pr-2"></div>

          <div class="flex gap-2">
            <input id="new-comment-input" type="text" placeholder="Share your thoughts..." class="flex-1 bg-stone-800 border border-stone-600 rounded px-3 py-2 text-sm text-white">
            <button id="post-comment-btn" class="bg-[#a83f39] text-white px-4 py-2 rounded text-sm font-serif">Post</button>
          </div>
          <p id="comment-hint" class="text-xs text-stone-400 mt-2">You must sign in to comment.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT START -->
  <script type="module">
    // ===============================
// Firebase (Modular SDK) imports
// ===============================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

import {
  getFirestore,
  doc, getDoc, setDoc, updateDoc,
  collection, addDoc, deleteDoc,
  query, orderBy, onSnapshot, getDocs,
  serverTimestamp, increment
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

import {
  getStorage,
  ref, uploadBytes, getDownloadURL, deleteObject
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

// ===============================
// Your Firebase config (qinghua-852c1)
// ===============================
const firebaseConfig = {
  apiKey: "AIzaSyBDvZ7oykdugl6DQH_p-0KOgy0sfMuMmFc",
  authDomain: "qinghua-852c1.firebaseapp.com",
  projectId: "qinghua-852c1",
  storageBucket: "qinghua-852c1.firebasestorage.app",
  messagingSenderId: "391709518256",
  appId: "1:391709518256:web:a18730b2d099c362e9ce75",
  measurementId: "G-8T36VSX6B6"
};

// ===============================
// Initialize Firebase services
// ===============================
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ===============================
// IMPORTANT: GitHub Pages domain
// ===============================
// 你需要去 Firebase Console -> Authentication -> Settings -> Authorized domains
// 添加：liusiyu4141-blip.github.io
// （不用添加 /huaqing.github.io/ 这一段，域名只写到 .io 即可）

// ===============================
// Global state
// ===============================
let currentUser = null;
let isAdmin = false;           // Admin = 登录后 + 输入 admin key 才会开启
let currentLang = "en";
let selectedArtworkId = null;
let selectedArtworkDoc = null;

// admin key (front-end only; not "secure", but fits your GitHub Pages scenario)
const ADMIN_KEY = "qinghua666";
// Specific Firebase User ID for the Administrator
const ADMIN_UID = "xSClMtHPxNYHJ1I5dZ3DNN2gq9l1";

// YouTube Shorts (replaceable by admin)
const DEFAULT_SHORTS_ID = "zN0VzZRzlqM";

// ===============================
// DOM helpers
// ===============================
const $ = (id) => document.getElementById(id);
const toast = (msg) => alert(msg);

// ===============================
// i18n content
// ===============================
const i18n = {
  en: {
    "seal": "Hua",
    "nav.home": "Home",
    "nav.source": "The Craft",
    "nav.artist": "Artist",
    "nav.gallery": "Gallery",
    "nav.contact": "Collect",

    "hero.subtitle": "The Ancient Art of Gongbi",
    "hero.title": "Timeless Serenity, Painted in Silk",
    "hero.desc": "\"Where the microscopic world meets infinite mindfulness.\"",
    "hero.button": "Explore Collection",
    "hero.seal": "Hua Qing",

    "video.caption": "Process video (loop)",
    "video.change": "Change Video",

    "gongbi.label": "The Origin",
    "gongbi.title": "Gongbi: Precision and Poise",
    "gongbi.p1":
      "Gongbi (工笔) is a meticulous Chinese painting tradition known for fine brushwork, controlled ink lines, and layered mineral pigments. Its roots can be traced back to early figure and court painting, and it matured into a highly refined style through imperial ateliers.",
    "gongbi.p2":
      "Historically, Gongbi flourished in the Tang dynasty (618–907) and reached new heights in the Song dynasty (960–1279), when artists pursued naturalistic detail, elegant composition, and subtle color transitions. In later periods, Gongbi continued to evolve through literati exchanges and regional schools.",
    "gongbi.p3":
      "Today, Gongbi remains a living craft—where patience becomes technique, and technique becomes tranquility.",
    "gongbi.list1": "Precision line work with hair-thin control",
    "gongbi.list2": "Layered pigments for luminous depth on silk or paper",
    "gongbi.list3": "A meditative process—slow, deliberate, and enduring",

    "artist.name": "Hua Qing",
    "artist.title": "Gongbi Artist",
    "artist.uploadTip": "Admin: Click to upload avatar",
    "artist.bio1":
      "Hua Qing is devoted to the classical Gongbi tradition, painting with delicate linework and calm composition. Each piece is built through disciplined layers—ink, color, and time—until life emerges in stillness.",
    "artist.bio2":
      "Her practice emphasizes the relationship between nature and mindfulness: birds, bamboo, blossoms, and quiet seasonal rhythms. The works invite viewers to slow down and notice detail—the place where attention becomes serenity.",
    "artist.bio3":
      "Through contemporary presentation and archival care, Hua Qing continues the Gongbi lineage with respect for history and a commitment to craft.",
    "artist.stat1": "Years",
    "artist.stat2": "Exhibitions",
    "artist.stat3": "Collections",

    "gallery.label": "Curated Collection",
    "gallery.title": "Ink & Rhythm",
    "gallery.filter.all": "All",
    "gallery.filter.flower": "Flowers",
    "gallery.filter.animal": "Animals",
    "gallery.filter.bird_flower": "Birds & Flowers",

    "contact.title": "Acquire & Connect",
    "contact.desc":
      "For acquisitions, commissions, or exhibitions, please reach out. Each artwork is handled with archival standards, and provenance notes can be provided upon request.",

    "form.name": "Your Name",
    "form.email": "Email Address",
    "form.message": "Inquiry / Message",
    "form.submit": "Send Inquiry",

    "footer.tagline": "Designed for the beauty of tranquility."
  },

  zh: {
    "seal": "花",
    "nav.home": "首页",
    "nav.source": "工笔来源",
    "nav.artist": "作者",
    "nav.gallery": "作品",
    "nav.contact": "联系收藏",

    "hero.subtitle": "工笔画的古典之美",
    "hero.title": "以绢为纸，写静为永恒",
    "hero.desc": "“在微观处见天地，在静心里得无穷。”",
    "hero.button": "浏览作品",
    "hero.seal": "花青",

    "video.caption": "创作短视频（循环）",
    "video.change": "更换视频",

    "gongbi.label": "起源与兴盛",
    "gongbi.title": "工笔：极致精微与从容气韵",
    "gongbi.p1":
      "工笔画（工笔）以严谨细密的线描、节制的设色与层层罩染著称。其传统可追溯至早期人物与宫廷绘画体系，并在长期的画院实践中逐步完善为高度成熟的绘画语言。",
    "gongbi.p2":
      "历史上，工笔画在唐代（618–907）逐渐兴盛，并在宋代（960–1279）达到新的高峰：写实观察、精致构图与微妙设色相互融合，形成兼具科学性与诗意的审美体系。此后历代延续发展，地域流派与文人趣味不断注入新的表达。",
    "gongbi.p3":
      "在当代，工笔仍是一门“慢工出细活”的活传统——用耐心成就技法，用技法抵达宁静。",
    "gongbi.list1": "丝发般的用线控制与结构刻画",
    "gongbi.list2": "多层设色与罩染，呈现温润通透的质感",
    "gongbi.list3": "缓慢而专注的过程：以时间换取深度",

    "artist.name": "花青",
    "artist.title": "工笔画家",
    "artist.uploadTip": "管理员：点击上传头像",
    "artist.bio1":
      "花青长期专注于传统工笔语言的当代表达，以细密线描与沉静构图营造“可观、可游、可居”的意境。每一幅作品都以严谨的步骤推进：起稿、勾线、分染、罩染与精修，层层叠加直至生机显现。",
    "artist.bio2":
      "她的创作主题多取自自然：竹影、花枝、飞鸟与四时之气。作品希望让观者放慢节奏，在细节中感受秩序与柔软——当注意力变得专注，宁静也随之出现。",
    "artist.bio3":
      "在尊重历史谱系的基础上，花青也重视作品的保存与呈现方式，以更适合当代观展的形式延续工笔的精微与雅正。",
    "artist.stat1": "年",
    "artist.stat2": "次展览",
    "artist.stat3": "件收藏",

    "gallery.label": "精选作品",
    "gallery.title": "墨与节律",
    "gallery.filter.all": "全部",
    "gallery.filter.flower": "花卉",
    "gallery.filter.animal": "动物",
    "gallery.filter.bird_flower": "花鸟",

    "contact.title": "收藏与联系",
    "contact.desc":
      "如需收藏、定制或展览合作，请联系。作品可提供保存建议与来源说明（provenance notes）。",

    "form.name": "姓名",
    "form.email": "邮箱",
    "form.message": "留言 / 需求",
    "form.submit": "发送",

    "footer.tagline": "为宁静之美而设计。"
  }
};

// ===============================
// UI: language
// ===============================
function applyLang(lang) {
  currentLang = lang;
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const k = el.getAttribute("data-i18n");
    if (i18n[lang] && i18n[lang][k] !== undefined) el.textContent = i18n[lang][k];
  });
  $("lang-btn-text").textContent = lang === "en" ? "中" : "EN";
  $("lang-btn-text-mobile").textContent = lang === "en" ? "中" : "EN";
}

// ===============================
// Video (YouTube Shorts embed OR Uploaded Video)
// ===============================
async function loadAboutVideo() {
  const cfgRef = doc(db, "siteConfig", "aboutVideo");
  const snap = await getDoc(cfgRef);
  const data = snap.exists() ? snap.data() : {};

  // Priority: Uploaded Video URL -> YouTube Shorts ID -> Default
  if (data.videoUrl) {
    // Render native video tag
    $("about-video-container").innerHTML = `
      <video
        id="native-video-player"
        src="${data.videoUrl}"
        autoplay
        loop
        playsinline
        class="w-full h-full object-cover"
      >
        Your browser does not support the video tag.
      </video>
    `;
    // Clean up styles
    $("about-video-container").style.aspectRatio = "";
    $("about-video-container").style.height = ""; 
    
    // Low Volume Sound Logic
    const v = document.getElementById("native-video-player");
    if(v) {
        v.volume = 0.15; // 15% volume
        v.muted = false; // Try unmute
        const p = v.play();
        if (p !== undefined) {
            p.catch(err => {
                console.log("Auto-play with sound blocked. Fallback to muted.");
                v.muted = true;
                v.play();
            });
        }
    }
    return;
  }

  let shortsId = data.shortsId || DEFAULT_SHORTS_ID;
  // Try mute=0 for YouTube sound (might be blocked)
  const src = `https://www.youtube.com/embed/${shortsId}?autoplay=1&mute=0&controls=0&playsinline=1&loop=1&playlist=${shortsId}&rel=0&modestbranding=1`;

  $("about-video-container").innerHTML = `
    <iframe
      src="${src}"
      title="YouTube video player"
      frameborder="0"
      allow="autoplay; encrypted-media; picture-in-picture"
      class="w-full h-full object-cover"
      allowfullscreen>
    </iframe>
  `;
  $("about-video-container").style.aspectRatio = ""; 
}

// Admin: Upload video file
async function uploadAboutVideo(file) {
  if (!currentUser || !isAdmin) { toast("Admin only."); return; }
  toast("Uploading video... This may take a while.");
  
  try {
    const key = `videos/about_${Date.now()}_${file.name}`;
    const r = ref(storage, key);
    await uploadBytes(r, file, { contentType: file.type });
    const url = await getDownloadURL(r);

    // Save url, clear shortsId to ensure priority
    await setDoc(doc(db, "siteConfig", "aboutVideo"), { 
      videoUrl: url, 
      shortsId: null, // Clear YouTube ID so Video URL takes precedence
      updatedAt: serverTimestamp() 
    }, { merge: true });
    
    await loadAboutVideo();
    toast("Video updated successfully.");
  } catch (e) {
    console.error(e);
    const uidInfo = currentUser ? `(User UID: ${currentUser.uid})` : "(Not Signed In)";
    toast(`Video upload failed: ${e.message}\n${uidInfo}`);
  }
}

// Admin: Set YouTube ID (Fallback)
async function setAboutVideoShortsId(shortsId) {
  // Clear videoUrl so YouTube ID takes precedence
  await setDoc(doc(db, "siteConfig", "aboutVideo"), { 
    shortsId, 
    videoUrl: null, 
    updatedAt: serverTimestamp() 
  }, { merge: true });
  await loadAboutVideo();
  toast("Video updated to YouTube source.");
}

// ===============================
// Auth modal UI
// ===============================
function openAuthModal() { $("authModal").classList.remove("hidden"); }
function closeAuthModal() { $("authModal").classList.add("hidden"); }

function openAdminModal() { $("adminModal").classList.remove("hidden"); }
function closeAdminModal() { $("adminModal").classList.add("hidden"); }

function showLoginTab() {
  $("tab-login").classList.add("text-[#a83f39]", "border-b-2", "border-[#a83f39]");
  $("tab-register").classList.remove("text-[#a83f39]", "border-b-2", "border-[#a83f39]");
  $("tab-register").classList.add("text-stone-400");
  $("form-login").classList.remove("hidden");
  $("form-register").classList.add("hidden");
}
function showRegisterTab() {
  $("tab-register").classList.add("text-[#a83f39]", "border-b-2", "border-[#a83f39]");
  $("tab-login").classList.remove("text-[#a83f39]", "border-b-2", "border-[#a83f39]");
  $("tab-login").classList.add("text-stone-400");
  $("form-register").classList.remove("hidden");
  $("form-login").classList.add("hidden");
}

// ===============================
// Admin mode (front-end)
// ===============================
function loadAdminFlagFromLocal() {
  const saved = localStorage.getItem("HQ_ADMIN_OK");
  isAdmin = saved === "1";
}

function setAdminFlag(ok) {
  isAdmin = ok;
  localStorage.setItem("HQ_ADMIN_OK", ok ? "1" : "0");
  updateAdminUI();
}

function updateAdminUI() {
  // Determine if effectively admin (either via UID or manual key override)
  const effectiveAdmin = currentUser && (currentUser.uid === ADMIN_UID || isAdmin);

  // Admin button: Show ONLY if effective admin
  // (Regular users shouldn't even see the button)
  if (effectiveAdmin) $("admin-btn").classList.remove("hidden");
  else $("admin-btn").classList.add("hidden");

  // Admin-edit overlay items (Video edit btn, Avatar upload overlay)
  if (effectiveAdmin) {
    $("video-edit-btn").classList.remove("hidden");
    $("artist-upload-overlay").classList.remove("hidden");
    $("artist-upload-overlay").classList.add("flex");
    if($("edit-bio-btn")) {
        $("edit-bio-btn").classList.remove("hidden");
        $("edit-bio-btn").classList.add("flex");
    }
    
    // Dashboard logic: Hide password box, show content
    if ($("admin-password-box")) {
        $("admin-password-box").classList.add("hidden");
    }
    if ($("admin-dashboard-content")) {
        $("admin-dashboard-content").classList.remove("hidden");
        setTimeout(() => $("admin-dashboard-content").classList.remove("opacity-0"), 50);
    }
  } else {
    // NOT Admin
    $("video-edit-btn").classList.add("hidden");
    $("artist-upload-overlay").classList.add("hidden");
    $("artist-upload-overlay").classList.remove("flex");
    if($("edit-bio-btn")) {
        $("edit-bio-btn").classList.add("hidden");
        $("edit-bio-btn").classList.remove("flex");
    }

    // If modal is open (which theoretically they shouldn't reach if button is hidden, 
    // but just in case they manually opened it or logged out while open):
    if ($("admin-password-box")) {
        $("admin-password-box").classList.remove("hidden");
    }
    if ($("admin-dashboard-content")) {
        $("admin-dashboard-content").classList.add("hidden", "opacity-0");
    }
  }

  // Modal inner admin panel (Edit/Delete buttons in artwork detail)
  if (effectiveAdmin) $("img-admin-edit-panel").classList.remove("hidden");
  else $("img-admin-edit-panel").classList.add("hidden");
}

// ===============================
// Auth UI state
// ===============================
function updateAuthUI() {
  const signedIn = !!currentUser;

  // Reset: IMPORTANT to avoid your "Signed in!" confusion
  // We only say signed in when we actually have user
  if (!signedIn) {
    $("user-name-display").textContent = "Sign In";
    $("signin-btn").classList.remove("hidden");
    $("signout-btn").classList.add("hidden");

    // mobile
    $("signin-btn-mobile").classList.remove("hidden");
    $("signout-btn-mobile").classList.add("hidden");

    // user-only features
    $("comment-hint").textContent = "You must sign in to comment.";
  } else {
    const name = currentUser.displayName || currentUser.email || "User";
    $("user-name-display").textContent = name;

    $("signin-btn").classList.remove("hidden");
    $("signout-btn").classList.remove("hidden");

    // mobile
    $("signin-btn-mobile").classList.add("hidden");
    $("signout-btn-mobile").classList.remove("hidden");

    $("comment-hint").textContent = "Write a comment and post.";
  }

  updateAdminUI();
}

// ===============================
// Firestore: user profile tracking (email + nickname)
// ===============================
async function upsertUserProfile(user) {
  const uref = doc(db, "users", user.uid);
  const snap = await getDoc(uref);
  const payload = {
    uid: user.uid,
    email: user.email || "",
    displayName: user.displayName || "",
    lastLoginAt: serverTimestamp()
  };
  if (!snap.exists()) {
    payload.createdAt = serverTimestamp();
    await setDoc(uref, payload);
  } else {
    await updateDoc(uref, payload);
  }
}

// ===============================
// Gallery rendering
// ===============================
function catLabel(cat) {
  if (currentLang === "zh") {
    if (cat === "flower") return "花卉";
    if (cat === "animal") return "走兽";
    if (cat === "bird_flower") return "花鸟";
    return "其他";
  } else {
    if (cat === "flower") return "Flowers";
    if (cat === "animal") return "Animals";
    if (cat === "bird_flower") return "Birds & Flowers";
    return "Other";
  }
}

function statusBadge(status) {
  const base = "inline-block px-2 py-1 text-xs rounded border";
  if (status === "Sold") return `${base} border-red-300 text-red-700 bg-red-50`;
  if (status === "Reserved") return `${base} border-amber-300 text-amber-800 bg-amber-50`;
  return `${base} border-emerald-300 text-emerald-700 bg-emerald-50`;
}

function createArtworkCard(docSnap) {
  const a = docSnap.data();
  const title = currentLang === "zh" ? (a.titleZh || "") : (a.titleEn || "");
  const desc = currentLang === "zh" ? (a.descZh || "") : (a.descEn || "");
  const cover = (a.imageUrls && a.imageUrls[0]) ? a.imageUrls[0] : "";

  const wrap = document.createElement("div");
  wrap.className = "break-inside-avoid group cursor-pointer";
  wrap.dataset.category = a.category || "all";

  wrap.innerHTML = `
    <div class="relative overflow-hidden rounded-lg shadow-lg bg-white">
      <div class="absolute top-3 left-3 ${statusBadge(a.status || "Available")}">${a.status || "Available"}</div>
      <img src="${cover}" alt="${title}" class="w-full h-auto object-cover transform group-hover:scale-105 transition duration-700 ease-out">
      <div class="p-5">
        <h3 class="text-2xl font-serif text-stone-800 italic mb-2">${escapeHtml(title)}</h3>
        <p class="text-stone-500 font-serif-text text-sm">${escapeHtml(desc)}</p>
        <div class="mt-3 flex items-center justify-between text-xs text-stone-400 uppercase tracking-widest">
          <span>${catLabel(a.category)}</span>
          <span class="text-[#a83f39]">${a.likesCount || 0} ❤</span>
        </div>
      </div>
    </div>
  `;

  wrap.addEventListener("click", () => openArtworkModal(docSnap.id, a));
  return wrap;
}

function renderGallery(docs) {
  const grid = $("gallery-grid");
  grid.innerHTML = "";
  if (!docs.length) {
    grid.innerHTML = `
      <div class="break-inside-avoid bg-stone-50 border border-stone-200 rounded p-6 text-center text-stone-500 font-serif-text">
        No artworks yet.
      </div>
    `;
    return;
  }
  docs.forEach(d => grid.appendChild(createArtworkCard(d)));
}

function escapeHtml(s) {
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// ===============================
// Artwork modal
// ===============================
function openModal() { $("imgModal").classList.remove("hidden"); document.body.style.overflow = "hidden"; }
function closeModal() {
  $("imgModal").classList.add("hidden");
  document.body.style.overflow = "";
  selectedArtworkId = null;
  selectedArtworkDoc = null;
  $("modalImagesContainer").innerHTML = "";
  $("comments-list").innerHTML = "";
}

function fillModalContent(art) {
  const title = currentLang === "zh" ? (art.titleZh || "") : (art.titleEn || "");
  const desc = currentLang === "zh" ? (art.descZh || "") : (art.descEn || "");
  $("modalTitle").textContent = title;
  $("modalDesc").textContent = desc;
  $("modalStatus").textContent = `Status: ${art.status || "Available"}`;
  $("like-count").textContent = String(art.likesCount || 0);

  // images
  $("modalImagesContainer").innerHTML = "";
  const urls = art.imageUrls || [];
  urls.forEach(u => {
    const img = document.createElement("img");
    img.src = u;
    img.className = "w-full rounded shadow-lg";
    $("modalImagesContainer").appendChild(img);
  });

  // admin selection
  $("modal-status-select").value = art.status || "Available";
}

function openArtworkModal(id, art) {
  selectedArtworkId = id;
  selectedArtworkDoc = art;
  fillModalContent(art);
  openModal();
  subscribeComments(id);
}

// ===============================
// Firestore: artworks live
// ===============================
let unsubArtworks = null;

function subscribeArtworks() {
  if (unsubArtworks) unsubArtworks();
  const qRef = query(collection(db, "artworks"), orderBy("createdAt", "desc"));

  unsubArtworks = onSnapshot(qRef, (snap) => {
    const docs = snap.docs;
    renderGallery(docs);

    // If modal open and current artwork updated -> refresh modal
    if (selectedArtworkId) {
      const found = docs.find(d => d.id === selectedArtworkId);
      if (found) {
        selectedArtworkDoc = found.data();
        fillModalContent(selectedArtworkDoc);
      }
    }
  }, (err) => {
    console.error(err);
    $("gallery-grid").innerHTML = `<div class="text-center text-red-600">Failed to load gallery.</div>`;
  });
}

// ===============================
// Comments live
// ===============================
let unsubComments = null;

function subscribeComments(artworkId) {
  if (unsubComments) unsubComments();
  const qRef = query(collection(db, "artworks", artworkId, "comments"), orderBy("createdAt", "desc"));
  unsubComments = onSnapshot(qRef, (snap) => {
    const box = $("comments-list");
    box.innerHTML = "";
    if (snap.empty) {
      box.innerHTML = `<p class="text-stone-400 text-sm">No comments yet.</p>`;
      return;
    }
    snap.forEach(d => {
      const c = d.data();
      const row = document.createElement("div");
      row.className = "border border-stone-700 rounded p-3";
      const who = c.displayName || c.email || "Anonymous";
      row.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-sm text-white font-serif">${escapeHtml(who)}</span>
          <span class="text-xs text-stone-400">${c.createdAt?.toDate ? c.createdAt.toDate().toLocaleString() : ""}</span>
        </div>
        <p class="text-stone-200 text-sm">${escapeHtml(c.text || "")}</p>
      `;
      box.appendChild(row);
    });
  });
}

// ===============================
// Likes
// ===============================
async function likeCurrentArtwork() {
  if (!selectedArtworkId) return;

  if (!currentUser) {
    toast("Please sign in to like.");
    openAuthModal();
    return;
  }

  const likeRef = doc(db, "artworks", selectedArtworkId, "likes", currentUser.uid);
  const likeSnap = await getDoc(likeRef);

  if (likeSnap.exists()) {
    toast("You already liked this.");
    return;
  }

  await setDoc(likeRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
  await updateDoc(doc(db, "artworks", selectedArtworkId), { likesCount: increment(1) });
}

// ===============================
// Post comment
// ===============================
async function postComment() {
  if (!selectedArtworkId) return;

  if (!currentUser) {
    toast("Please sign in to comment.");
    openAuthModal();
    return;
  }

  const text = $("new-comment-input").value.trim();
  if (!text) return;

  await addDoc(collection(db, "artworks", selectedArtworkId, "comments"), {
    text,
    uid: currentUser.uid,
    email: currentUser.email || "",
    displayName: currentUser.displayName || "",
    createdAt: serverTimestamp()
  });

  $("new-comment-input").value = "";
}

// ===============================
// Admin: upload avatar
// ===============================
async function loadArtistProfile() {
  const pRef = doc(db, "siteConfig", "artistProfile");
  const snap = await getDoc(pRef);
  if (snap.exists()) {
    const d = snap.data();
    if (d.avatarUrl) $("artist-img").src = d.avatarUrl;
    
    // Check for custom bio overrides
    if (d.bio) {
        // Merge into i18n object so language switching works
        if (d.bio.en) {
            i18n.en["artist.bio1"] = d.bio.en.p1 || i18n.en["artist.bio1"];
            i18n.en["artist.bio2"] = d.bio.en.p2 || i18n.en["artist.bio2"];
            i18n.en["artist.bio3"] = d.bio.en.p3 || i18n.en["artist.bio3"];
        }
        if (d.bio.zh) {
            i18n.zh["artist.bio1"] = d.bio.zh.p1 || i18n.zh["artist.bio1"];
            i18n.zh["artist.bio2"] = d.bio.zh.p2 || i18n.zh["artist.bio2"];
            i18n.zh["artist.bio3"] = d.bio.zh.p3 || i18n.zh["artist.bio3"];
        }
        // Re-apply current lang to update UI immediately
        applyLang(currentLang);
    }
  }
}

async function saveArtistBio(p1, p2, p3) {
  if (!currentUser || !isAdmin) return toast("Admin only.");
  
  const pRef = doc(db, "siteConfig", "artistProfile");
  
  // Construct update path based on current language
  // We need to use dot notation for nested fields update to avoid overwriting other lang
  const updateData = {};
  updateData[`bio.${currentLang}.p1`] = p1;
  updateData[`bio.${currentLang}.p2`] = p2;
  updateData[`bio.${currentLang}.p3`] = p3;
  updateData.updatedAt = serverTimestamp();

  try {
      await setDoc(pRef, updateData, { merge: true });
      
      // Update local state immediately
      i18n[currentLang]["artist.bio1"] = p1;
      i18n[currentLang]["artist.bio2"] = p2;
      i18n[currentLang]["artist.bio3"] = p3;
      applyLang(currentLang);
      
      toast("Biography updated successfully!");
      $("bioModal").classList.add("hidden");
  } catch (e) {
      console.error(e);
      toast("Failed to save bio: " + e.message);
  }
}

async function uploadArtistAvatar(file) {
  if (!currentUser || !isAdmin) {
    toast("Admin only.");
    return;
  }
  
  try {
    const key = `avatars/artist_${Date.now()}_${file.name}`;
    const r = ref(storage, key);
    await uploadBytes(r, file, { contentType: file.type });
    const url = await getDownloadURL(r);

    await setDoc(doc(db, "siteConfig", "artistProfile"), { avatarUrl: url, updatedAt: serverTimestamp() }, { merge: true });
    $("artist-img").src = url;
    toast("Avatar updated.");
  } catch (e) {
      console.error(e);
      const uidInfo = currentUser ? `(User UID: ${currentUser.uid})` : "(Not Signed In)";
      toast(`Avatar upload failed: ${e.message}\n${uidInfo}`);
  }
}

// ===============================
// Admin: add artwork (Storage upload + Firestore doc)
// ===============================
let stagedFiles = [];

function setupDropZone() {
  const dropArea = $("drop-area");
  const fileElem = $("fileElem");
  if (!dropArea || !fileElem) return; // Guard clause

  function highlight() { dropArea.classList.add("border-[#a83f39]", "bg-[#a83f39]/5"); }
  function unhighlight() { dropArea.classList.remove("border-[#a83f39]", "bg-[#a83f39]/5"); }

  ["dragenter","dragover"].forEach(evt => dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); highlight(); }));
  ["dragleave","drop"].forEach(evt => dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); unhighlight(); }));

  dropArea.addEventListener("drop", (e) => {
    const files = [...(e.dataTransfer.files || [])].filter(f => f.type.startsWith("image/"));
    if (!files.length) return;
    stagedFiles.push(...files);
    renderStagedPreviews();
  });

  fileElem.addEventListener("change", (e) => {
    const files = [...(e.target.files || [])].filter(f => f.type.startsWith("image/"));
    if (!files.length) return;
    stagedFiles.push(...files);
    renderStagedPreviews();
    fileElem.value = "";
  });
  
  // Make the drop zone clickable to trigger input
  dropArea.addEventListener("click", (e) => {
      // Avoid triggering if clicking child elements (like existing buttons if any)
      if (e.target !== fileElem) fileElem.click();
  });
}

function renderStagedPreviews() {
  const box = $("upload-previews");
  box.innerHTML = "";
  stagedFiles.forEach((f, idx) => {
    const url = URL.createObjectURL(f);
    const div = document.createElement("div");
    div.className = "relative w-16 h-16 flex-shrink-0";
    div.innerHTML = `
      <img src="${url}" class="w-16 h-16 object-cover rounded border border-stone-300"/>
      <button data-idx="${idx}" class="absolute -top-2 -right-2 bg-red-700 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center">x</button>
    `;
    div.querySelector("button").addEventListener("click", (e) => {
      const i = Number(e.currentTarget.dataset.idx);
      stagedFiles.splice(i, 1);
      renderStagedPreviews();
    });
    box.appendChild(div);
  });
}

async function uploadFilesToStorage(files) {
  const urls = [];
  for (const file of files) {
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const key = `artworks/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;
    const r = ref(storage, key);
    await uploadBytes(r, file, { contentType: file.type });
    const url = await getDownloadURL(r);
    urls.push({ url, path: key });
  }
  return urls;
}

async function publishArtwork() {
  // Admin only
  if (!currentUser || !isAdmin) {
    toast("Admin only. Please sign in and verify admin key.");
    return;
  }

  const titleZh = $("new-title-zh").value.trim();
  const titleEn = $("new-title-en").value.trim();
  const descZh = $("new-desc-zh").value.trim();
  const descEn = $("new-desc-en").value.trim();
  const category = $("new-category").value;
  const status = $("new-status").value;

  if (!titleZh && !titleEn) {
    toast("Please enter a title.");
    return;
  }
  if (!stagedFiles.length) {
    toast("Please upload at least one image.");
    return;
  }

  // Upload images to Storage
  try {
    toast("Uploading images and publishing... please wait.");
    const uploaded = await uploadFilesToStorage(stagedFiles);
    const imageUrls = uploaded.map(x => x.url);
    const imagePaths = uploaded.map(x => x.path);

    // Create Firestore doc
    await addDoc(collection(db, "artworks"), {
      titleZh, titleEn, descZh, descEn,
      category, status,
      imageUrls,
      imagePaths,        // used for deletion from Storage
      likesCount: 0,
      createdAt: serverTimestamp(),
      createdBy: currentUser.uid
    });

    // reset
    $("new-title-zh").value = "";
    $("new-title-en").value = "";
    $("new-desc-zh").value = "";
    $("new-desc-en").value = "";
    $("new-category").value = "flower";
    $("new-status").value = "Available";
    stagedFiles = [];
    renderStagedPreviews();

    toast("Published!");
  } catch (e) {
    console.error(e);
    // Enhanced error message for debugging permissions
    const uidInfo = currentUser ? `(User UID: ${currentUser.uid})` : "(Not Signed In)";
    toast(`Publish failed: ${e?.message || e}\n${uidInfo}\nPlease check Firebase Storage Rules.`);
  }
}

// ===============================
// Admin: update status & delete artwork
// ===============================
async function adminUpdateStatus() {
  if (!currentUser || !isAdmin) { toast("Admin only."); return; }
  if (!selectedArtworkId) return;

  const newStatus = $("modal-status-select").value;
  await updateDoc(doc(db, "artworks", selectedArtworkId), { status: newStatus });
  toast("Status updated.");
}

async function adminDeleteArtwork() {
  if (!currentUser || !isAdmin) { toast("Admin only."); return; }
  if (!selectedArtworkId) return;

  const ok = confirm("Delete this artwork? This will remove Firestore doc and attempt to delete Storage files.");
  if (!ok) return;

  const artRef = doc(db, "artworks", selectedArtworkId);
  const snap = await getDoc(artRef);
  if (!snap.exists()) return;

  const data = snap.data();
  const paths = data.imagePaths || [];

  // Delete Firestore doc first (so UI updates quickly)
  await deleteDoc(artRef);

  // Best-effort delete storage files
  for (const p of paths) {
    try {
      await deleteObject(ref(storage, p));
    } catch (e) {
      console.warn("Failed to delete storage object:", p, e);
    }
  }

  toast("Artwork deleted.");
  closeModal();
}

// ===============================
// Admin: users list
// ===============================
async function loadUsersList() {
  if (!currentUser || !isAdmin) { toast("Admin only."); return; }
  const box = $("user-list-content");
  box.innerHTML = `<div class="text-stone-400">Loading...</div>`;
  const qs = await getDocs(query(collection(db, "users"), orderBy("createdAt", "desc")));
  if (qs.empty) {
    box.innerHTML = `<div class="text-stone-400">No users.</div>`;
    return;
  }
  box.innerHTML = "";
  qs.forEach(d => {
    const u = d.data();
    const row = document.createElement("div");
    row.className = "flex items-center justify-between border-b border-stone-200 pb-2";
    row.innerHTML = `
      <div>
        <div class="font-bold text-stone-700">${escapeHtml(u.displayName || "(no nick)")}</div>
        <div class="text-stone-500">${escapeHtml(u.email || "")}</div>
      </div>
      <div class="text-stone-400">${u.createdAt?.toDate ? u.createdAt.toDate().toLocaleDateString() : ""}</div>
    `;
    box.appendChild(row);
  });
}

// ===============================
// Navbar & mobile menu
// ===============================
function setupNavbar() {
  const navbar = $("navbar");
  window.addEventListener("scroll", () => {
    if (window.scrollY > 50) navbar.classList.add("shadow-md");
    else navbar.classList.remove("shadow-md");
  });

  $("mobile-menu-btn").addEventListener("click", () => {
    $("mobile-menu").classList.toggle("hidden");
  });
}

// ===============================
// Gallery filter
// ===============================
function setupFilters() {
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".filter-btn").forEach(b => {
        b.classList.remove("text-[#a83f39]", "border-b", "border-[#a83f39]");
      });
      btn.classList.add("text-[#a83f39]", "border-b", "border-[#a83f39]");

      const f = btn.dataset.filter;
      document.querySelectorAll("#gallery-grid > div").forEach(card => {
        const cat = card.dataset.category || "all";
        if (f === "all" || cat === f) card.style.display = "";
        else card.style.display = "none";
      });
    });
  });
}

// ===============================
// Bind UI events
// ===============================
function bindUI() {
  // language
  $("lang-btn").addEventListener("click", () => applyLang(currentLang === "en" ? "zh" : "en"));
  $("lang-btn-mobile").addEventListener("click", () => applyLang(currentLang === "en" ? "zh" : "en"));

  // auth modal open
  $("signin-btn").addEventListener("click", () => {
    if (currentUser) {
      // signed in: clicking name opens admin modal if admin, else do nothing
      openAuthModal();
    } else {
      openAuthModal();
    }
  });
  $("signin-btn-mobile").addEventListener("click", () => openAuthModal());

  // auth modal close
  $("auth-close").addEventListener("click", closeAuthModal);
  $("authModal").addEventListener("click", (e) => { if (e.target === $("authModal")) closeAuthModal(); });

  // tabs
  $("tab-login").addEventListener("click", showLoginTab);
  $("tab-register").addEventListener("click", showRegisterTab);

  // login
  $("login-submit").addEventListener("click", async () => {
    const email = $("login-email").value.trim();
    const pw = $("login-password").value;
    try {
      await signInWithEmailAndPassword(auth, email, pw);
      closeAuthModal();
      toast("Signed in!");
    } catch (e) {
      console.error(e);
      toast(e?.message || "Sign in failed.");
    }
  });

  // register
  $("reg-submit").addEventListener("click", async () => {
    const email = $("reg-email").value.trim();
    const pw = $("reg-password").value;
    const nick = $("reg-nick").value.trim();

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      if (nick) await updateProfile(cred.user, { displayName: nick });

      await upsertUserProfile(cred.user);

      closeAuthModal();
      toast("Registered and signed in!");
    } catch (e) {
      console.error(e);
      toast(e?.message || "Register failed.");
    }
  });

  // sign out
  $("signout-btn").addEventListener("click", async () => {
    await signOut(auth);
    setAdminFlag(false); // clear admin on logout
    toast("Signed out.");
  });
  $("signout-btn-mobile").addEventListener("click", async () => {
    await signOut(auth);
    setAdminFlag(false);
    toast("Signed out.");
  });

  // admin modal
  $("admin-btn").addEventListener("click", () => openAdminModal());
  $("admin-close").addEventListener("click", closeAdminModal);
  $("adminModal").addEventListener("click", (e) => { if (e.target === $("adminModal")) closeAdminModal(); });

  // admin verify key
  $("admin-verify").addEventListener("click", () => {
    const key = $("admin-key").value;
    if (!currentUser) {
      $("admin-status").textContent = "Please sign in first.";
      return;
    }
    if (key === ADMIN_KEY) {
      $("admin-status").textContent = "Admin enabled on this device.";
      setAdminFlag(true);
    } else {
      $("admin-status").textContent = "Wrong admin key.";
      setAdminFlag(false);
    }
  });

  // admin publish
  $("publish-artwork").addEventListener("click", publishArtwork);
  $("load-users").addEventListener("click", loadUsersList);

  // modal close
  $("modal-close").addEventListener("click", closeModal);
  $("imgModal").addEventListener("click", (e) => {
    if (e.target === $("imgModal")) closeModal();
  });

  // likes & comments
  $("like-btn").addEventListener("click", likeCurrentArtwork);
  $("post-comment-btn").addEventListener("click", postComment);

  // admin update & delete
  $("status-update-btn").addEventListener("click", adminUpdateStatus);
  $("delete-btn").addEventListener("click", adminDeleteArtwork);

  // video change (admin)
  $("video-edit-btn").addEventListener("click", async () => {
    if (!isAdmin || !currentUser) return toast("Admin only.");
    
    const choice = prompt("Enter '1' to upload a Video File, or '2' to use a YouTube ID.");
    if (choice === "1") {
        $("video-file-input").click();
        return;
    }
    
    if (choice === "2") {
        const input = prompt("Paste YouTube Shorts URL or Shorts ID:");
        if (!input) return;

        // Extract ID from URL like https://www.youtube.com/shorts/xxxx
        let id = input.trim();
        const m = id.match(/shorts\/([a-zA-Z0-9_-]{6,})/);
        if (m) id = m[1];
        // or watch?v=
        const m2 = id.match(/v=([a-zA-Z0-9_-]{6,})/);
        if (m2) id = m2[1];

        await setAboutVideoShortsId(id);
    }
  });

  // video file input change
  $("video-file-input").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    // Limit size if needed, e.g. 50MB
    if (f.size > 50 * 1024 * 1024) {
        toast("File too large. Please upload video under 50MB.");
        return;
    }
    await uploadAboutVideo(f);
    e.target.value = "";
  });

  // artist avatar upload
  $("artist-file-input").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    toast("Uploading avatar...");
    await uploadArtistAvatar(f);
    e.target.value = "";
  });

  // drop zone
  setupDropZone();

  // filters
  setupFilters();
  
  // Edit Bio (Admin)
  $("edit-bio-btn").addEventListener("click", () => {
      // Pre-fill with current text
      $("edit-bio-p1").value = i18n[currentLang]["artist.bio1"];
      $("edit-bio-p2").value = i18n[currentLang]["artist.bio2"];
      $("edit-bio-p3").value = i18n[currentLang]["artist.bio3"];
      $("bioModal").classList.remove("hidden");
  });
  
  $("bio-close").addEventListener("click", () => $("bioModal").classList.add("hidden"));
  $("bio-cancel").addEventListener("click", () => $("bioModal").classList.add("hidden"));
  
  $("bio-save").addEventListener("click", () => {
      saveArtistBio(
          $("edit-bio-p1").value.trim(),
          $("edit-bio-p2").value.trim(),
          $("edit-bio-p3").value.trim()
      );
  });
}

// ===============================
// Auth observer
// ===============================
onAuthStateChanged(auth, async (user) => {
  currentUser = user || null;
  
  if (currentUser) {
    // Auto-detect admin via UID
    if (currentUser.uid === ADMIN_UID) {
        console.log("Admin auto-recognized via UID.");
        // We don't strictly need to set isAdmin (local storage flag) 
        // because updateAdminUI now checks (currentUser.uid === ADMIN_UID || isAdmin)
        // But we can set it for consistency if we want.
        isAdmin = true; 
    }
  }

  // IMPORTANT: avoid "false signed in" alerts
  // We do NOT auto-alert here.
  updateAuthUI();

  if (currentUser) {
    try { await upsertUserProfile(currentUser); } catch {}
  } else {
    // Signed out
    isAdmin = false; // Reset memory flag
    // We generally keep localStorage flag, but for security via UID, it's safer to rely on UID.
  }
});

// ===============================
// Storage rules note (WHY you get storage/unauthorized)
// ===============================
// 你的报错 "storage/unauthorized" 说明：Firebase Storage Rules 现在不允许未登录用户写入
// 这是正确的！
// 但你“右上角还显示 Sign In”说明你其实没真的登录成功（或者域名未加入 Authorized domains）
// 所以 Storage 拒绝写入，这是正常现象。
// 解决步骤：
// 1) Firebase Console -> Authentication -> Settings -> Authorized domains 添加：liusiyu4141-blip.github.io
// 2) Authentication -> Sign-in method -> 开启 Email/Password
// 3) Storage -> Rules (临时开发) 允许登录用户写： allow write: if request.auth != null;
// 4) 刷新网页，重新登录，再上传

// ===============================
// Initialize
// ===============================
function initIcons() {
  lucide.createIcons();
}

async function init() {
  initIcons();
  setupNavbar();
  bindUI();

  loadAdminFlagFromLocal();
  updateAdminUI();

  applyLang("en");

  await loadAboutVideo();
  await loadArtistProfile();

  subscribeArtworks();
}

init();

  </script>
</body>
</html>
